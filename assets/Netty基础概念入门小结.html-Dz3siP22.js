import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,a as t}from"./app-2Nmlc3aW.js";const p={},e=t(`<h1 id="netty基础概念入门小结" tabindex="-1"><a class="header-anchor" href="#netty基础概念入门小结"><span>Netty基础概念入门小结</span></a></h1><h2 id="来了解一下需要nio" tabindex="-1"><a class="header-anchor" href="#来了解一下需要nio"><span>来了解一下需要NIO</span></a></h2><p>在了解Netty之前，我们必须了解一些基础的概念，首先自然是传统的BIO模型，我们以代码示例的方式给出BIO服务端的代码，逻辑非常清晰:</p><ol><li>创建一个服务端，端口号设置为8888。</li><li>创建一个线程，等待客户端建立连接。</li><li>为了实现多客户端通信，收到客户端连接申请，需要专门创建一个新的线程和当前客户端保持通信状态。</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * BIO 服务端
 *
 * <span class="token keyword">@author</span> shrk-chili
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IOServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建一个线程等待连接进来的客户端</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">waitConnect</span><span class="token punctuation">(</span>serverSocket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">waitConnect</span><span class="token punctuation">(</span><span class="token class-name">ServerSocket</span> serverSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 1. 阻塞方法获取新连接</span>
                <span class="token class-name">Socket</span> socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 2. 每个客户端来了，就专门创建一个新的连接处理</span>
                <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 3. 按字节流方式读取数据</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; receive msg:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同理我们也给出客户端代码，笔者这里创建了3个线程创建客户端，并向客户端写数据:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * BIO 客户端
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IOClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;client-&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>随后我们将服务端和客户端启动，可以看到服务端会输出下面这样的结果，可以看到服务端为了客户端专门创建一个线程确保何其通信。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>Thread-1 receive msg:Tue Aug <span class="token number">22</span> <span class="token number">23</span>:03:32 CST <span class="token number">2023</span>: hello world
Thread-3 receive msg:Tue Aug <span class="token number">22</span> <span class="token number">23</span>:03:32 CST <span class="token number">2023</span>: hello world
Thread-2 receive msg:Tue Aug <span class="token number">22</span> <span class="token number">23</span>:03:32 CST <span class="token number">2023</span>: hello world
Thread-2 receive msg:Tue Aug <span class="token number">22</span> <span class="token number">23</span>:03:33 CST <span class="token number">2023</span>: hello world
Thread-3 receive msg:Tue Aug <span class="token number">22</span> <span class="token number">23</span>:03:33 CST <span class="token number">2023</span>: hello world
Thread-1 receive msg:Tue Aug <span class="token number">22</span> <span class="token number">23</span>:03:33 CST <span class="token number">2023</span>: hello world
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样就会导致下面这些问题：</p><ol><li>高并发场景下，多线程会导致频繁的上下文切换，导致某些任务可能迟迟无法结束。</li><li>资源浪费，创建一个线程需要在斩上分配64k甚至是1M的内存空间。</li><li>每一个和客户端保持通信的线程并不是实时都有消息接受，可能会有很长一段时间处于空闲阻塞状态，造成没必要的性能开销。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025428.png" alt="在这里插入图片描述"></p><p>于是我们就有了NIO的概念，如下图所示，在NIO模型上，我们只需用一个线程处理每个客户端的连接请求，收到请求后不再建立新的连接，而是将连接绑定到clientSelector上。 之后客户端的读写请求都会被clientSelector线程轮询到，我们完全可以建立一个线程池将这些事件扔到线程池中，但是这里笔者做了简化，直接用clientSelector的线程处理读写请求，不难看出NIO模型做到了用最少的线程处理尽可能多的连接。</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025405.png" alt="在这里插入图片描述"></p><p>于是我们给出了NIO的示例代码，可以看到代码非常冗长且复杂，但是整体逻辑也很笔者上述差不多:</p><ol><li>创建serverSelector 轮询是否有新连接。</li><li>创建serverSelector 轮询到新连接，则建立连接后注册读事件到clientSelector 上。</li><li>clientSelector 轮询，处理每个客户端的连接。</li><li>clientSelector 处理完轮询到的事件后将事件的key移除。</li></ol><p>这里笔者都已给出注释，读者可自行参阅。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NIOServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//负责轮询是否有新连接</span>
        <span class="token class-name">Selector</span> serverSelector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//负责处理每个客户端是否有数据可读</span>
        <span class="token class-name">Selector</span> clientSelector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//创建服务端socket监听通道</span>
                <span class="token class-name">ServerSocketChannel</span> listenerChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//绑定端口</span>
                listenerChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置为非阻塞监听</span>
                listenerChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//注册感兴趣的事件为OP_ACCEPT事件</span>
                listenerChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>serverSelector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//阻塞1毫秒查看是否有新的连接进来</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>serverSelector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> serverSelector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> keyIterator <span class="token operator">=</span> set<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">while</span> <span class="token punctuation">(</span>keyIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> keyIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//判断是否是新的socket连接加入</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;有新的socket连接加入&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//接收此通道与socket的连接</span>
                                <span class="token class-name">SocketChannel</span> clientChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                clientChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//服务端监测到新连接之后，不再创建一个新线程，而是直接将</span>
                                <span class="token comment">//新连接绑定到clientSelector上</span>
                                clientChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>clientSelector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                keyIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>


            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//通过clientSelector.select(1)方法可以轮询</span>
                    <span class="token comment">//出来，进而批量处理</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientSelector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> clientSelector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> keyIterator <span class="token operator">=</span> set<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>keyIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> keyIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                    <span class="token comment">//获取事件的通道</span>
                                    <span class="token class-name">SocketChannel</span> clientChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token comment">//数据的读写面向Buffer</span>
                                    <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token comment">//读取数据到buffer中</span>
                                    clientChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">defaultCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                    keyIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调试的客户端代码完成可以基于上一个例子，运行后从输出结果可以看出3个客户端对应的请求都用一个线程处理了。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>有新的socket连接加入
有新的socket连接加入
有新的socket连接加入
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">32</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">32</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">32</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">33</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">33</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">33</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">34</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">34</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">34</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> hello world
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看出原生NIO虽然相对BIO减小了一定开销且提高一定的性能，但是缺点也很明显:</p><ol><li>原生的JDK的NIO概念非常多，使用非常复杂对新手不友好。</li><li>底层使用epoll，很容易导致空轮询进而出现CPU100%。</li><li>没有对建立连接和处理请求的两个处理建立线程模型，无法较好的发挥它的优势，需要自己进行扩展实现。</li><li>项目庞大后，会出现各种奇奇怪怪的bug，很难排查，且维护成本较高。</li></ol><h2 id="netty详解" tabindex="-1"><a class="header-anchor" href="#netty详解"><span>Netty详解</span></a></h2><h3 id="netty简介" tabindex="-1"><a class="header-anchor" href="#netty简介"><span>Netty简介</span></a></h3><p>相对与JDK的原生nio，Netty与之相比有着一下的优势:</p><ol><li>统一的API，支持多种传输类型、阻塞的和非阻塞的简单而强大的线程模型，真正的无连接数据报套接字，支持链接逻辑组件以支持复用。</li><li>易于使用，各种配置只需几个方法的调用就能完成。</li><li>性能较好，拥有比 Java 的核心API更高的吞吐量以及更低的延迟得益于池化和复用，拥有更低的资源消耗最少的内存复制。</li><li>健壮，不会因为慢速、快速或者超载的连接而导致OutOfMemoryError消除在高速网络中NIO应用程序常见的不公平读/写比率。</li><li>安全，完整的SSL/TLS以及 StartTLS支持可用于受限环境下，如Applet和 OSGI。</li><li>社区活跃。</li></ol><h3 id="代码示例" tabindex="-1"><a class="header-anchor" href="#代码示例"><span>代码示例</span></a></h3><h4 id="基础代码示例" tabindex="-1"><a class="header-anchor" href="#基础代码示例"><span>基础代码示例</span></a></h4><p>同样以上面的NIO模型，我们使用Netty编写的服务端代码示例如下，整体步骤非常简单就能完成服务端配置了:</p><ol><li>创建serverBootstrap，创建两个NioEventLoopGroup即可完成连接监听和事件处理的线程组配置。</li><li>channel方法即可完成模型的配置，这里我们选择NIO模型。</li><li>childHandler即可完成对读写事件处理的配置。</li><li>在childHandler里笔者添加了一个SimpleChannelInboundHandler的处理器，该处理器会在服务端与客户端建立连接后调用initChannel，于是笔者通过nioSocketChannel.pipeline()得到处理链添加一个SimpleChannelInboundHandler用于处理所有客户端的发送的消息。</li><li>后续一些serverBootstrap的各种配置即可完成TCP等参数配置，读者可自行参阅。</li><li>调用bind完成异步连接端口，该方法返回一个future用于判断连接状态。</li></ol><p>对应完整的代码，笔者都已详尽注释，读者可自行参阅。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 启动一个netty服务端需要指定 线程模型 IO模型 业务处理逻辑</span>

        <span class="token comment">// 引导类负责引导服务端启动工作</span>
        <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 以下两个对象可以看做是两个线程组</span>

        <span class="token comment">// 负责监听端口，接受新的连接</span>
        <span class="token class-name">NioEventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 负责处理每一个连接读写的线程组</span>
        <span class="token class-name">NioEventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置线程组并指定NIO模型</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                <span class="token comment">//设置IO模型，这里为NioServerSocketChannel,建议Linux服务器使用 EpollServerSocketChannel</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">// 定义后续每个连接的数据读写，对于业务处理逻辑</span>
                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span> nioSocketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        nioSocketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token annotation punctuation">@Override</span>
                                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// handler() 方法 用于指定服务端启动时的一些逻辑; 注意 childHandler() 方法是为每个新连接添加的处理逻辑，通常用不到</span>
<span class="token comment">//        serverBootstrap.handler(new ChannelInitializer&lt;NioSocketChannel&gt;() {</span>
<span class="token comment">//            @Override</span>
<span class="token comment">//            protected void initChannel(NioSocketChannel nioSocketChannel) throws Exception {</span>
<span class="token comment">//</span>
<span class="token comment">//            }</span>
<span class="token comment">//        });</span>


        <span class="token comment">// attr() 方法 用于给 NioServerSocketChannel 维护一个 Map，通常也用不到这个方法</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">&quot;serverName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;nettyServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// childAttr() 方法 可以为每个连接都指定自定义的属性</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">childAttr</span><span class="token punctuation">(</span><span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">&quot;clientKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;clientValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// option() 方法 用于给服务端Channel设置一些TCP参数 SO_BACKLOG 表示系统用于临时存放已完成三次握手的请求的队列的最大长度</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// childOption() 方法 用于给每个连接都设置一些TCP参数，SO_KEEPALIVE 表示是否开启TCP心跳机制</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TCP_NODELAY 表示是否开启Nagle算法,如果要求高实时性，有数据发送时就马上发送，就设置为关闭；如果需要减少发送次数，减少网络交互，就设置为开启</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">bind</span><span class="token punctuation">(</span>serverBootstrap<span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 以端口号递增的形式尝试绑定端口号
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ServerBootstrap</span> serverBootstrap<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// bind 方法是异步的，为其添加监听器，如果绑定成功则结束，反之端口号+1进行绑定</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>future <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;端口[&quot;</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">&quot;]绑定成功!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;端口[&quot;</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">&quot;]绑定失败!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">bind</span><span class="token punctuation">(</span>serverBootstrap<span class="token punctuation">,</span> port <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样的客户端代码如下，整体步骤也差不多，唯一区别就是客户端没有bossGroup，读者可参考注释理解:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClient</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 最大重连间隔
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_RETRY</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 整体即完成netty客户端需要指定线程模型、IO模型、业务处理逻辑</span>

        <span class="token comment">// 负责客户端的启动</span>
        <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 客户端的线程模型</span>
        <span class="token class-name">NioEventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 指定线程组</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>workerGroup<span class="token punctuation">)</span>
                <span class="token comment">//指定NIO模型</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">// IO处理逻辑</span>
                <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// attr() 方法 用于给NioSocketChannel指定一个Map 按需从其中取值</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">&quot;clientName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;nettyClient&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// option() 方法用于指定一些TCP参数 CONNECT_TIMEOUT_MILLIS 指定连接超时的时间</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">CONNECT_TIMEOUT_MILLIS</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// SO_KEEPALIVE 表示是否开启TCP心跳机制</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TCP_NODELAY 表示是否开启Nagle算法</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 建立连接</span>
                <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>bootstrap<span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">,</span> <span class="token constant">MAX_RETRY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;发送消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: Hello world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 建立连接的方法，使用监听器来进行重试
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Channel</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Bootstrap</span> bootstrap<span class="token punctuation">,</span> <span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//connect会返回一个异步的future，所以我们可以通过添加监听查看连接结果</span>
        <span class="token keyword">return</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>future <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;连接成功!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>retry <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;重试次数已用完，放弃连接！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 第几次重连</span>
                        <span class="token keyword">int</span> order <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">MAX_RETRY</span> <span class="token operator">-</span> retry<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token comment">// 定时任务下次执行重连的时间</span>
                        <span class="token keyword">int</span> delay <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> order<span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: 连接失败，第&quot;</span> <span class="token operator">+</span> order <span class="token operator">+</span> <span class="token string">&quot;次重连……&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//递归进入下一次重连</span>
                        bootstrap<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">connect</span><span class="token punctuation">(</span>bootstrap<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> retry <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                delay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动后服务端输出结果:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>端口<span class="token punctuation">[</span><span class="token number">8888</span><span class="token punctuation">]</span>绑定成功<span class="token operator">!</span>
nioEventLoopGroup<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">15</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> <span class="token class-name">Hello</span> world<span class="token operator">!</span>
nioEventLoopGroup<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">15</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> <span class="token class-name">Hello</span> world<span class="token operator">!</span>
nioEventLoopGroup<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">15</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> <span class="token class-name">Hello</span> world<span class="token operator">!</span>
nioEventLoopGroup<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> <span class="token class-name">Hello</span> world<span class="token operator">!</span>
nioEventLoopGroup<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> <span class="token class-name">Hello</span> world<span class="token operator">!</span>
nioEventLoopGroup<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Tue</span> <span class="token class-name">Aug</span> <span class="token number">22</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> <span class="token class-name">Hello</span> world<span class="token operator">!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>客户端输出结果:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span>发送消息
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">3</span>发送消息
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span>发送消息
连接成功<span class="token operator">!</span>
连接成功<span class="token operator">!</span>
连接成功<span class="token operator">!</span>
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span>发送消息
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span>发送消息
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">3</span>发送消息
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="客户端服务端双向通信示例" tabindex="-1"><a class="header-anchor" href="#客户端服务端双向通信示例"><span>客户端服务端双向通信示例</span></a></h4><p>上一个示例我们完成了客户端和服务端基础使用示例，接下来我们要实现一个需求，我们希望客户端发送给服务端<code>hello Netty Server</code>后，服务端会向客户端回复:<code>Hello Netty client</code>。</p><p>于是我们的服务端配置代码如下，可以看出该客户端按需添加了这样一条逻辑链:</p><ol><li>收到客户端消息后，InboundHandlerA先处理消息。</li><li>InboundHandlerB再处理。</li><li>FirstServerHandler再处理。</li><li>写出数据时，OutboundHandlerA先写，OutboundHandlerB后写。</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">NioEventLoopGroup</span> boss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NioEventLoopGroup</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>boss<span class="token punctuation">,</span> worker<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 处理读数据的逻辑</span>
                        ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InboundHandlerA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InboundHandlerB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">//负责处理客户端的读写事件</span>
                        ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FirstServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// 处理写数据的逻辑</span>
                        ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutboundHandlerA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutboundHandlerB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应InboundHandlerA代码如下，InboundHandlerB同理仅修改输出结果:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InboundHandlerA</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;InBoundHandlerA: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">channelRead</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>FirstServerHandler 代码如下，该类继承ChannelInboundHandlerAdapter并注册到逻辑链上，使得服务端收到消息时会回调channelRead方法，我们就可以通过这个方法处理读请求，并将需要写的数据发送给客户端。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FirstServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 收到客户端数据后会回调该方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token comment">//打印读取到的数据</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: 服务端读到数据 -&gt; &quot;</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 回复客户端数据</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: 服务端写出数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//组装数据并发送</span>
        <span class="token class-name">ByteBuf</span> out <span class="token operator">=</span> <span class="token function">getByteBuf</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ByteBuf</span> <span class="token function">getByteBuf</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> buffer <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token string">&quot;Hello Netty client &quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        buffer<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>OutboundHandlerA 代码如下，OutboundHandlerB同理仅修改输出。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OutboundHandlerA</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OutBoundHandlerA: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同理服务端配置类代码如下，可以看到逻辑链山添加一个FirstClientHandler处理器。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NioEventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//和服务端建立连接后会调用该方法</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">//返回逻辑处理链</span>
                        ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token comment">//添加客户端逻辑处理器</span>
                       <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FirstClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应FirstClientHandler 代码如下，可以看到该类继承ChannelInboundHandlerAdapter ，使得客户端处理做到以下几点:</p><ol><li>和服务端建立连接后调用channelActive，我们就可以再此时发送数据给服务端。</li><li>服务端回复消息时，逻辑链就会回调channelRead，我们就可以读取服务端的消息。</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FirstClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 客户端连接服务端成功后会回调该方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: 客户端写出数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取数据</span>
        <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token function">getByteBuf</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 把数据写到服务端</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ByteBuf</span> <span class="token function">getByteBuf</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token string">&quot;hello Netty Server&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ByteBuf</span> buffer <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        buffer<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 收到服务端数据后，会回调该方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端读到数据 -&gt; &quot;</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动后服务端输出结果如下，可以看到输出顺序就是我们逻辑链上配置的顺序，唯一就是OutBound顺序相反了:<code>InBoundHandlerA-&gt;InBoundHandlerB-&gt;FirstServerHandler-&gt;OutBoundHandlerB OutBoundHandlerA</code>。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">InBoundHandlerA</span><span class="token operator">:</span> <span class="token class-name">PooledUnsafeDirectByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token class-name">InBoundHandlerB</span><span class="token operator">:</span> <span class="token class-name">PooledUnsafeDirectByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token class-name">Wed</span> <span class="token class-name">Aug</span> <span class="token number">23</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">17</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> 服务端读到数据 <span class="token operator">-&gt;</span> hello <span class="token class-name">Netty</span> <span class="token class-name">Server</span>
<span class="token class-name">Wed</span> <span class="token class-name">Aug</span> <span class="token number">23</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">17</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> 服务端写出数据
<span class="token class-name">OutBoundHandlerB</span><span class="token operator">:</span> <span class="token class-name">PooledUnsafeDirectByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">19</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">256</span><span class="token punctuation">)</span>
<span class="token class-name">OutBoundHandlerA</span><span class="token operator">:</span> <span class="token class-name">PooledUnsafeDirectByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">19</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">256</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>客户端输出结果，可以看到收到服务端的回复了:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">Wed</span> <span class="token class-name">Aug</span> <span class="token number">23</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">17</span> <span class="token constant">CST</span> <span class="token number">2023</span><span class="token operator">:</span> 客户端写出数据
客户端读到数据 <span class="token operator">-&gt;</span> <span class="token class-name">Hello</span> <span class="token class-name">Netty</span> client 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="异步和事件驱动" tabindex="-1"><a class="header-anchor" href="#异步和事件驱动"><span>异步和事件驱动</span></a></h3><p>Netty的设计思想就是通过选择器使用较少的线程监听更多的连接上的事件，实现非阻塞式的网络IO，结合异步回调的方式调用用户对于IO的逻辑，正是这种工作机制，使得Netty可以从容的应付高并发场景。</p><h2 id="netty核心组件概览" tabindex="-1"><a class="header-anchor" href="#netty核心组件概览"><span>Netty核心组件概览</span></a></h2><h3 id="管道-channel" tabindex="-1"><a class="header-anchor" href="#管道-channel"><span>管道(Channel)</span></a></h3><p>我们常常称之为管道，这里我们暂时可以将其理解为一个数据的载体，通过Channel我们可以收到别的数据，也可以将自己的数据发送出去，同样的我们也可以将这个管道打开或者关闭。</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025160.png" alt="在这里插入图片描述"></p><h3 id="什么是回调" tabindex="-1"><a class="header-anchor" href="#什么是回调"><span>什么是回调</span></a></h3><p>这个和Netty无关，我们可以说回调其实是一种设计思想，我们还是以Netty为例，例如我们希望在连接被建立进行一些响应的处理，那么Netty就会在连接建立的时候预埋一个接口方法。</p><p>如下图，AbstractChannelHandlerContext就编写了一个ChannelInboundHandler接口channelActive方法。</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025859.png" alt="在这里插入图片描述"></p><p>如果我们希望在源码下方即连接建立的时候进行响应的处理，我们就可以继承这个接口，然后编写自己的逻辑，如下代码所示(具体案例笔者会在后文介绍，这里暂时了解一下就行了):</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>public class ConnectHandler extends ChannelInboundHandlerAdapter <span class="token punctuation">{</span>
    @Override
    //当一个新的连接已经被建立时，channelActive<span class="token punctuation">(</span>ChannelHandlerContext<span class="token punctuation">)</span>将会被调用
    public void channelActive<span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">)</span>
            throws Exception <span class="token punctuation">{</span>
        System.out.println<span class="token punctuation">(</span>
                <span class="token string">&quot;Client &quot;</span> + ctx.channel<span class="token punctuation">(</span><span class="token punctuation">)</span>.remoteAddress<span class="token punctuation">(</span><span class="token punctuation">)</span> + <span class="token string">&quot; connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="future和channel串联" tabindex="-1"><a class="header-anchor" href="#future和channel串联"><span>Future和channel串联</span></a></h3><p>jdk中也有Future相关的概念，只不过Netty对此进行了进一步的优化，如下代码所示，当Netty需要建立连接时，只需使用connect方法建立连接即可，该方法会返回一个ChannelFuture 。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code> //异步地连接到远程节点
        ChannelFuture future <span class="token operator">=</span> channel.connect<span class="token punctuation">(</span>
                new InetSocketAddress<span class="token punctuation">(</span><span class="token string">&quot;192.168.0.1&quot;</span>, <span class="token number">25</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而ChannelFuture 则是Netty继承JDK的Future之后自己编写的Future。</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025768.png" alt="在这里插入图片描述"></p><p>那么ChannelFuture 的优化点在哪呢？如下图所示，可以看到Netty使用异步建立连接任务之后，会通过回调的方式，调用我们的注册到future监听上的事件，这就使得我们无需像使用Future那样去阻塞等待或者说时不时的手动判断连接情况，对于连接完成的处理会变得更加高效灵活。</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025781.png" alt="在这里插入图片描述"></p><h3 id="eventloop" tabindex="-1"><a class="header-anchor" href="#eventloop"><span>EventLoop</span></a></h3><p>Netty通过EventLoop将Selector抽象出来,EventLoop为我们做了如下几件事情：</p><ol><li>注册感兴趣的事件。</li><li>派发请求给响应Handler。</li><li>安排进一步的工作。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025149.png" alt="在这里插入图片描述"></p><h2 id="netty基础示例演示" tabindex="-1"><a class="header-anchor" href="#netty基础示例演示"><span>Netty基础示例演示</span></a></h2><h3 id="服务端代码示例" tabindex="-1"><a class="header-anchor" href="#服务端代码示例"><span>服务端代码示例</span></a></h3><p>通过上文我们了解了关于Netty一些概念，我们不妨编写一段代码入门一下Netty，首先我们编写一下服务端的代码，我们首先编写一下服务端的回调处理器，具体参见下方注释，可以看到逻辑很简单:</p><ol><li>当服务端收到请求，我们会让服务端走到我们EchoServerHandler ，它会通过channelRead接受客户端请求并输出到控制台，然后告诉客户端收到请求了。</li><li>通过channelReadComplete告知channelRead当前读取的消息是最后一条消息了。</li><li>当遇到异常时，通过exceptionCaught进行处理错误，避免该请求走到后续注册到ChannelPipeline的channel收到这个请求。</li></ol><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>//标示一个ChannelHandler可以被多个 Channel 安全地共享
@Sharable
public class EchoServerHandler extends ChannelInboundHandlerAdapter <span class="token punctuation">{</span>
    @Override
    public void channelRead<span class="token punctuation">(</span>ChannelHandlerContext ctx, Object msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ByteBuf <span class="token keyword">in</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ByteBuf<span class="token punctuation">)</span> msg<span class="token punctuation">;</span>

        // 创建一个Bytebuf，默认创建的容量是256
        ByteBuf buffer <span class="token operator">=</span> ByteBufAllocator.DEFAULT.buffer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String resp <span class="token operator">=</span> <span class="token string">&quot;服务端收到你的请求了&quot;</span><span class="token punctuation">;</span>
        // 将数据写入ByteBuf
        buffer.writeBytes<span class="token punctuation">(</span>resp.getBytes<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>


        //将消息记录到控制台
        System.out.println<span class="token punctuation">(</span>
                <span class="token string">&quot;服务端收到客户端的请求: &quot;</span> + in.toString<span class="token punctuation">(</span>CharsetUtil.UTF_8<span class="token punctuation">))</span><span class="token punctuation">;</span>
        //将接收到的消息写给发送者，而不冲刷出站消息
        ctx.write<span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public void channelReadComplete<span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">)</span>
            throws Exception <span class="token punctuation">{</span>
        //将未决消息冲刷到远程节点，并且关闭该 Channel
        ctx.writeAndFlush<span class="token punctuation">(</span>Unpooled.EMPTY_BUFFER<span class="token punctuation">)</span>
                .addListener<span class="token punctuation">(</span>ChannelFutureListener.CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public void exceptionCaught<span class="token punctuation">(</span>ChannelHandlerContext ctx,
                                Throwable cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        //打印异常栈跟踪
        cause.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        //关闭该Channel
        ctx.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完成处理器的逻辑之后，我们就可以创建服务端了，代码如下，笔者已经给出详细逻辑这里就不多赘述了，唯一需要注意的就是<code>ch.pipeline().addLast(serverHandler);</code>就是告知服务端，收到请求后要走的回调处理器要用到我们的EchoServerHandler。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>public class EchoServer <span class="token punctuation">{</span>
    private final int port<span class="token punctuation">;</span>

    public EchoServer<span class="token punctuation">(</span>int port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        this.port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        throws Exception <span class="token punctuation">{</span>

        //设置端口值
        int port <span class="token operator">=</span> <span class="token number">7000</span><span class="token punctuation">;</span>
        //调用服务器的 start<span class="token punctuation">(</span><span class="token punctuation">)</span>方法
        new EchoServer<span class="token punctuation">(</span>port<span class="token punctuation">)</span>.start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public void start<span class="token punctuation">(</span><span class="token punctuation">)</span> throws Exception <span class="token punctuation">{</span>
        //自定义的ChannelHandler
        final EchoServerHandler serverHandler <span class="token operator">=</span> new EchoServerHandler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        //<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 创建EventLoopGroup
        EventLoopGroup group <span class="token operator">=</span> new NioEventLoopGroup<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{</span>
            //<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 创建ServerBootstrap
            ServerBootstrap b <span class="token operator">=</span> new ServerBootstrap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b.group<span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                //<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> 指定所使用的 NIO 传输 Channel
                .channel<span class="token punctuation">(</span>NioServerSocketChannel.class<span class="token punctuation">)</span>
                //<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> 使用指定的端口设置套接字地址
                .localAddress<span class="token punctuation">(</span>new InetSocketAddress<span class="token punctuation">(</span>port<span class="token punctuation">))</span>
                //<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> 添加一个EchoServerHandler到于Channel的 ChannelPipeline
                .childHandler<span class="token punctuation">(</span>new ChannelInitializer<span class="token operator">&lt;</span>SocketChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    @Override
                    public void initChannel<span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{</span>
                        //EchoServerHandler 被标注为@Shareable，所以我们可以总是使用同样的实例
                        //这里对于所有的客户端连接来说，都会使用同一个 EchoServerHandler，因为其被标注为@Sharable，
                        //这将在后面的章节中讲到。
                        ch.pipeline<span class="token punctuation">(</span><span class="token punctuation">)</span>.addLast<span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> 异步地绑定服务器；调用 sync<span class="token punctuation">(</span><span class="token punctuation">)</span>方法阻塞等待直到绑定完成
            ChannelFuture f <span class="token operator">=</span> b.bind<span class="token punctuation">(</span><span class="token punctuation">)</span>.sync<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System.out.println<span class="token punctuation">(</span>EchoServer.class.getSimpleName<span class="token punctuation">(</span><span class="token punctuation">)</span> +
                <span class="token string">&quot; 开始异步地绑定服务器: &quot;</span> + f.channel<span class="token punctuation">(</span><span class="token punctuation">)</span>.localAddress<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
            //<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> 获取 Channel 的CloseFuture，并且阻塞当前线程直到它完成
            f.channel<span class="token punctuation">(</span><span class="token punctuation">)</span>.closeFuture<span class="token punctuation">(</span><span class="token punctuation">)</span>.sync<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
            //<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> 关闭 EventLoopGroup，释放所有的资源
            group.shutdownGracefully<span class="token punctuation">(</span><span class="token punctuation">)</span>.sync<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="客户端示例" tabindex="-1"><a class="header-anchor" href="#客户端示例"><span>客户端示例</span></a></h3><p>同样我们编写客户端的回调处理器:</p><ol><li>它会在连接建立时触发channelActive回调，发送给服务端&quot;你好，我是客户端&quot;。通过channelRead0获取服务端发送的消息。</li><li>通过channelRead0收到服务器的请求。</li><li>通过exceptionCaught记录连接过程中的错误。</li></ol><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>//标记该类的实例可以被多个 Channel 共享
@Sharable
public class EchoClientHandler
    extends SimpleChannelInboundHandler<span class="token operator">&lt;</span>ByteBuf<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    @Override
    public void channelActive<span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        //当被通知 Channel是活跃的时候，发送一条消息
        ctx.writeAndFlush<span class="token punctuation">(</span>Unpooled.copiedBuffer<span class="token punctuation">(</span><span class="token string">&quot;你好，我是客户端&quot;</span>, CharsetUtil.UTF_8<span class="token punctuation">))</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public void channelRead0<span class="token punctuation">(</span>ChannelHandlerContext ctx, ByteBuf <span class="token keyword">in</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        //记录已接收消息的转储
        System.out.println<span class="token punctuation">(</span>
                <span class="token string">&quot;客户端收到服务端消息: &quot;</span> + in.toString<span class="token punctuation">(</span>CharsetUtil.UTF_8<span class="token punctuation">))</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    //在发生异常时，记录错误并关闭Channel
    public void exceptionCaught<span class="token punctuation">(</span>ChannelHandlerContext ctx,
        Throwable cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cause.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后编写客户端的启动代码</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>public class EchoClient <span class="token punctuation">{</span>
    private final String <span class="token function">host</span><span class="token punctuation">;</span>
    private final int port<span class="token punctuation">;</span>

    public EchoClient<span class="token punctuation">(</span>String host, int port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        this.host <span class="token operator">=</span> <span class="token function">host</span><span class="token punctuation">;</span>
        this.port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public void start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        throws Exception <span class="token punctuation">{</span>
        EventLoopGroup group <span class="token operator">=</span> new NioEventLoopGroup<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{</span>
            //创建 Bootstrap
            Bootstrap b <span class="token operator">=</span> new Bootstrap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //指定 EventLoopGroup 以处理客户端事件；需要适用于 NIO 的实现
            b.group<span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                //适用于 NIO 传输的Channel 类型
                .channel<span class="token punctuation">(</span>NioSocketChannel.class<span class="token punctuation">)</span>
                //设置服务器的InetSocketAddress
                .remoteAddress<span class="token punctuation">(</span>new InetSocketAddress<span class="token punctuation">(</span>host, port<span class="token punctuation">))</span>
                //在创建Channel时，向 ChannelPipeline中添加一个 EchoClientHandler实例
                .handler<span class="token punctuation">(</span>new ChannelInitializer<span class="token operator">&lt;</span>SocketChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    @Override
                    public void initChannel<span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span>
                        throws Exception <span class="token punctuation">{</span>
                        ch.pipeline<span class="token punctuation">(</span><span class="token punctuation">)</span>.addLast<span class="token punctuation">(</span>
                             new EchoClientHandler<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //连接到远程节点，阻塞等待直到连接完成
            ChannelFuture f <span class="token operator">=</span> b.connect<span class="token punctuation">(</span><span class="token punctuation">)</span>.sync<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //阻塞，直到Channel 关闭
            f.channel<span class="token punctuation">(</span><span class="token punctuation">)</span>.closeFuture<span class="token punctuation">(</span><span class="token punctuation">)</span>.sync<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
            //关闭线程池并且释放所有的资源
            group.shutdownGracefully<span class="token punctuation">(</span><span class="token punctuation">)</span>.sync<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
            throws Exception <span class="token punctuation">{</span>


        final String <span class="token function">host</span> <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">;</span>
        final int port <span class="token operator">=</span> <span class="token number">7000</span><span class="token punctuation">;</span>
        new EchoClient<span class="token punctuation">(</span>host, port<span class="token punctuation">)</span>.start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="运行效果" tabindex="-1"><a class="header-anchor" href="#运行效果"><span>运行效果</span></a></h3><p>如下图我们首先运行服务端,可以看到服务端监听7000端口了。</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025218.png" alt="在这里插入图片描述"></p><p>然后将客户端启动，服务端就会收到消息</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025292.png" alt="在这里插入图片描述"></p><p>同样的客户端也会收到服务端的回复</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025592.png" alt="在这里插入图片描述"></p><p>自此我们就简单的完成了Netty的基础入门。</p>`,102),o=[e];function c(l,i){return s(),a("div",null,o)}const r=n(p,[["render",c],["__file","Netty基础概念入门小结.html.vue"]]),d=JSON.parse('{"path":"/%E6%A1%86%E6%9E%B6/Netty/Netty%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8%E5%B0%8F%E7%BB%93.html","title":"Netty基础概念入门小结","lang":"zh-CN","frontmatter":{"description":"Netty基础概念入门小结 来了解一下需要NIO 在了解Netty之前，我们必须了解一些基础的概念，首先自然是传统的BIO模型，我们以代码示例的方式给出BIO服务端的代码，逻辑非常清晰: 创建一个服务端，端口号设置为8888。 创建一个线程，等待客户端建立连接。 为了实现多客户端通信，收到客户端连接申请，需要专门创建一个新的线程和当前客户端保持通信状态...","head":[["meta",{"property":"og:url","content":"https://maijunxuan.cn/%E6%A1%86%E6%9E%B6/Netty/Netty%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8%E5%B0%8F%E7%BB%93.html"}],["meta",{"property":"og:site_name","content":"麦俊轩的博客"}],["meta",{"property":"og:title","content":"Netty基础概念入门小结"}],["meta",{"property":"og:description","content":"Netty基础概念入门小结 来了解一下需要NIO 在了解Netty之前，我们必须了解一些基础的概念，首先自然是传统的BIO模型，我们以代码示例的方式给出BIO服务端的代码，逻辑非常清晰: 创建一个服务端，端口号设置为8888。 创建一个线程，等待客户端建立连接。 为了实现多客户端通信，收到客户端连接申请，需要专门创建一个新的线程和当前客户端保持通信状态..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025428.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-08-28T00:49:57.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:alt","content":"Netty基础概念入门小结"}],["meta",{"property":"article:author","content":"maijunxuan"}],["meta",{"property":"article:modified_time","content":"2023-08-28T00:49:57.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Netty基础概念入门小结\\",\\"image\\":[\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025428.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025405.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025160.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025859.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025768.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025781.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025149.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025218.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025292.png\\",\\"https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/img202308231025592.png\\"],\\"dateModified\\":\\"2023-08-28T00:49:57.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"maijunxuan\\",\\"email\\":\\"maijunxuan0309@gmail.com\\"}]}"]]},"headers":[{"level":2,"title":"来了解一下需要NIO","slug":"来了解一下需要nio","link":"#来了解一下需要nio","children":[]},{"level":2,"title":"Netty详解","slug":"netty详解","link":"#netty详解","children":[{"level":3,"title":"Netty简介","slug":"netty简介","link":"#netty简介","children":[]},{"level":3,"title":"代码示例","slug":"代码示例","link":"#代码示例","children":[]},{"level":3,"title":"异步和事件驱动","slug":"异步和事件驱动","link":"#异步和事件驱动","children":[]}]},{"level":2,"title":"Netty核心组件概览","slug":"netty核心组件概览","link":"#netty核心组件概览","children":[{"level":3,"title":"管道(Channel)","slug":"管道-channel","link":"#管道-channel","children":[]},{"level":3,"title":"什么是回调","slug":"什么是回调","link":"#什么是回调","children":[]},{"level":3,"title":"Future和channel串联","slug":"future和channel串联","link":"#future和channel串联","children":[]},{"level":3,"title":"EventLoop","slug":"eventloop","link":"#eventloop","children":[]}]},{"level":2,"title":"Netty基础示例演示","slug":"netty基础示例演示","link":"#netty基础示例演示","children":[{"level":3,"title":"服务端代码示例","slug":"服务端代码示例","link":"#服务端代码示例","children":[]},{"level":3,"title":"客户端示例","slug":"客户端示例","link":"#客户端示例","children":[]},{"level":3,"title":"运行效果","slug":"运行效果","link":"#运行效果","children":[]}]}],"git":{"createdTime":1693183797000,"updatedTime":1693183797000,"contributors":[{"name":"MJX","email":"1585225345@qq.com","commits":1}]},"readingTime":{"minutes":20.67,"words":6202},"filePathRelative":"框架/Netty/Netty基础概念入门小结.md","localizedDate":"2023年8月28日","excerpt":"\\n<h2>来了解一下需要NIO</h2>\\n<p>在了解Netty之前，我们必须了解一些基础的概念，首先自然是传统的BIO模型，我们以代码示例的方式给出BIO服务端的代码，逻辑非常清晰:</p>\\n<ol>\\n<li>创建一个服务端，端口号设置为8888。</li>\\n<li>创建一个线程，等待客户端建立连接。</li>\\n<li>为了实现多客户端通信，收到客户端连接申请，需要专门创建一个新的线程和当前客户端保持通信状态。</li>\\n</ol>\\n<div class=\\"language-java\\" data-ext=\\"java\\" data-title=\\"java\\"><pre class=\\"language-java\\"><code><span class=\\"token doc-comment comment\\">/**\\n * BIO 服务端\\n *\\n * <span class=\\"token keyword\\">@author</span> shrk-chili\\n */</span>\\n<span class=\\"token keyword\\">public</span> <span class=\\"token keyword\\">class</span> <span class=\\"token class-name\\">IOServer</span> <span class=\\"token punctuation\\">{</span>\\n    <span class=\\"token keyword\\">public</span> <span class=\\"token keyword\\">static</span> <span class=\\"token keyword\\">void</span> <span class=\\"token function\\">main</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">String</span><span class=\\"token punctuation\\">[</span><span class=\\"token punctuation\\">]</span> args<span class=\\"token punctuation\\">)</span> <span class=\\"token keyword\\">throws</span> <span class=\\"token class-name\\">IOException</span> <span class=\\"token punctuation\\">{</span>\\n        <span class=\\"token class-name\\">ServerSocket</span> serverSocket <span class=\\"token operator\\">=</span> <span class=\\"token keyword\\">new</span> <span class=\\"token class-name\\">ServerSocket</span><span class=\\"token punctuation\\">(</span><span class=\\"token number\\">8888</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token comment\\">//创建一个线程等待连接进来的客户端</span>\\n        <span class=\\"token keyword\\">new</span> <span class=\\"token class-name\\">Thread</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span> <span class=\\"token operator\\">-&gt;</span> <span class=\\"token function\\">waitConnect</span><span class=\\"token punctuation\\">(</span>serverSocket<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">start</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token punctuation\\">}</span>\\n\\n    <span class=\\"token keyword\\">private</span> <span class=\\"token keyword\\">static</span> <span class=\\"token keyword\\">void</span> <span class=\\"token function\\">waitConnect</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">ServerSocket</span> serverSocket<span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n        <span class=\\"token keyword\\">while</span> <span class=\\"token punctuation\\">(</span><span class=\\"token boolean\\">true</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n            <span class=\\"token keyword\\">try</span> <span class=\\"token punctuation\\">{</span>\\n                <span class=\\"token comment\\">// 1. 阻塞方法获取新连接</span>\\n                <span class=\\"token class-name\\">Socket</span> socket <span class=\\"token operator\\">=</span> serverSocket<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">accept</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n                <span class=\\"token comment\\">// 2. 每个客户端来了，就专门创建一个新的连接处理</span>\\n                <span class=\\"token keyword\\">new</span> <span class=\\"token class-name\\">Thread</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span> <span class=\\"token operator\\">-&gt;</span> <span class=\\"token punctuation\\">{</span>\\n                    <span class=\\"token keyword\\">int</span> len<span class=\\"token punctuation\\">;</span>\\n                    <span class=\\"token keyword\\">byte</span><span class=\\"token punctuation\\">[</span><span class=\\"token punctuation\\">]</span> data <span class=\\"token operator\\">=</span> <span class=\\"token keyword\\">new</span> <span class=\\"token keyword\\">byte</span><span class=\\"token punctuation\\">[</span><span class=\\"token number\\">1024</span><span class=\\"token punctuation\\">]</span><span class=\\"token punctuation\\">;</span>\\n                    <span class=\\"token keyword\\">try</span> <span class=\\"token punctuation\\">{</span>\\n                        <span class=\\"token class-name\\">InputStream</span> inputStream <span class=\\"token operator\\">=</span> socket<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getInputStream</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n                        <span class=\\"token comment\\">// 3. 按字节流方式读取数据</span>\\n                        <span class=\\"token keyword\\">while</span> <span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">(</span>len <span class=\\"token operator\\">=</span> inputStream<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">read</span><span class=\\"token punctuation\\">(</span>data<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span> <span class=\\"token operator\\">!=</span> <span class=\\"token operator\\">-</span><span class=\\"token number\\">1</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n                            <span class=\\"token class-name\\">System</span><span class=\\"token punctuation\\">.</span>out<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">println</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">Thread</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">currentThread</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getName</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span> <span class=\\"token operator\\">+</span> <span class=\\"token string\\">\\" receive msg:\\"</span> <span class=\\"token operator\\">+</span> <span class=\\"token keyword\\">new</span> <span class=\\"token class-name\\">String</span><span class=\\"token punctuation\\">(</span>data<span class=\\"token punctuation\\">,</span> <span class=\\"token number\\">0</span><span class=\\"token punctuation\\">,</span> len<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n                        <span class=\\"token punctuation\\">}</span>\\n                    <span class=\\"token punctuation\\">}</span> <span class=\\"token keyword\\">catch</span> <span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">IOException</span> e<span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n                        <span class=\\"token keyword\\">throw</span> <span class=\\"token keyword\\">new</span> <span class=\\"token class-name\\">RuntimeException</span><span class=\\"token punctuation\\">(</span>e<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n                    <span class=\\"token punctuation\\">}</span>\\n                <span class=\\"token punctuation\\">}</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">start</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n            <span class=\\"token punctuation\\">}</span> <span class=\\"token keyword\\">catch</span> <span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">IOException</span> e<span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n                e<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">printStackTrace</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n            <span class=\\"token punctuation\\">}</span>\\n        <span class=\\"token punctuation\\">}</span>\\n    <span class=\\"token punctuation\\">}</span>\\n<span class=\\"token punctuation\\">}</span>\\n</code></pre></div>","autoDesc":true}');export{r as comp,d as data};
