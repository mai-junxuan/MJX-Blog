<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.7" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.23" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://maijunxuan.cn/%E4%B8%AD%E9%97%B4%E4%BB%B6/Canal/Canal%E7%9A%84%E4%BD%BF%E7%94%A8.html"><meta property="og:site_name" content="麦俊轩的博客"><meta property="og:title" content="一、背景"><meta property="og:description" content="一、背景 工作中有个需求，当数据库的数据变更时，另外一个系统中的数据要能及时感应到，通过调研知道，监听数据库的binlog可以做到一个准实时的通知，而canal主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费，正好满足需求，此处记录一下canal的简单使用。 二、canal的工作原理 canal的工作原理 步骤： canal模拟m..."><meta property="og:type" content="article"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/202208080239150.webp"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-06-13T21:01:35.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="一、背景"><meta property="article:author" content="maijunxuan"><meta property="article:modified_time" content="2023-06-13T21:01:35.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"一、背景","image":["https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/202208080239150.webp","https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/202209022334753.webp"],"dateModified":"2023-06-13T21:01:35.000Z","author":[{"@type":"Person","name":"maijunxuan"}]}</script><meta name="robots" content="all"><meta name="author" content="maijunxuan"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="apple-mobile-web-app-capable" content="yes"><link rel="icon" href="/favicon.ico"><title>一、背景 | 麦俊轩的博客</title><meta name="description" content="一、背景 工作中有个需求，当数据库的数据变更时，另外一个系统中的数据要能及时感应到，通过调研知道，监听数据库的binlog可以做到一个准实时的通知，而canal主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费，正好满足需求，此处记录一下canal的简单使用。 二、canal的工作原理 canal的工作原理 步骤： canal模拟m...">
    <link rel="preload" href="/assets/style-BoXsG0LU.css" as="style"><link rel="stylesheet" href="/assets/style-BoXsG0LU.css">
    <link rel="modulepreload" href="/assets/app-Digg1ELS.js"><link rel="modulepreload" href="/assets/Canal的使用.html-h-8ki5nw.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.png" alt><!----><span class="vp-site-name hide-in-pad">麦俊轩的博客</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="日常"><span class="title"><!---->日常</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/%E6%97%A5%E5%B8%B8/IDEA%E7%BF%BB%E8%AF%91%E6%8F%92%E4%BB%B6%E6%8A%A5%E9%94%99%E6%9B%B4%E6%96%B0TKK%E7%9A%84%E9%97%AE%E9%A2%98.html" aria-label="IDEA翻译插件报错更新TKK的问题"><!---->IDEA翻译插件报错更新TKK的问题<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/%E6%97%A5%E5%B8%B8/Vue3%E4%B8%AD%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8this.html" aria-label="Vue3中为什么不能使用this"><!---->Vue3中为什么不能使用this<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/%E6%97%A5%E5%B8%B8/windows%E7%AB%AF%E5%8F%A3%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3.html" aria-label="windows端口冲突解决"><!---->windows端口冲突解决<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/%E6%97%A5%E5%B8%B8/%E8%A7%A3%E5%86%B3%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81.html" aria-label="解决依赖冲突"><!---->解决依赖冲突<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Java"><span class="title"><!---->Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/Java/Java%E5%9F%BA%E7%A1%80%E5%B0%8F%E7%BB%93.html" aria-label="Java基础小结"><!---->Java基础小结<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Java/Java%E6%B3%A8%E8%A7%A3%E5%B0%8F%E7%BB%93.html" aria-label="Java注解小结"><!---->Java注解小结<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Java/Java%E5%8F%8D%E5%B0%84%E5%B0%8F%E7%BB%93.html" aria-label="Java反射小结"><!---->Java反射小结<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Java/Java%E4%B8%AD%E7%9A%84%E6%B3%9B%E5%9E%8B.html" aria-label="Java中的泛型"><!---->Java中的泛型<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Java/谈谈Java的异常.html" aria-label="谈谈Java的异常"><!---->谈谈Java的异常<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Java/Lambda%E5%AE%9E%E8%B7%B5.html" aria-label="Lambda实践"><!---->Lambda实践<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Java/Stream%E6%B5%81%E5%AE%9E%E8%B7%B5.html" aria-label="Stream流实践"><!---->Stream流实践<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Java/Java%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2.html" aria-label="Java中的字符串"><!---->Java中的字符串<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="JUC"><span class="title"><!---->JUC</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/Java%E4%B8%AD%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0.html" aria-label="Java中的线程池"><!---->Java中的线程池<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/Java%E4%B8%AD%E7%9A%84%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html" aria-label="Java中的并发容器"><!---->Java中的并发容器<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/%E8%B0%88%E8%B0%88ThreadLocal.html" aria-label="谈谈ThreadLocal"><!---->谈谈ThreadLocal<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/synchronized%E7%9A%84%E4%BC%98%E5%8C%96.html" aria-label="synchronized的优化"><!---->synchronized的优化<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/CAS%E5%92%8C%E5%8E%9F%E5%AD%90%E7%B1%BB.html" aria-label="CAS和原子类"><!---->CAS和原子类<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/volatile%E5%92%8CCAS%E7%9A%84%E5%BC%8A%E7%AB%AF.html" aria-label="volatile和CAS的弊端"><!---->volatile和CAS的弊端<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/CompletableFuture%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html" aria-label="CompletableFuture简单使用"><!---->CompletableFuture简单使用<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/AQS%E7%AE%80%E8%BF%B0.html" aria-label="AQS简述"><!---->AQS简述<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/JUC/JUC%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB.html" aria-label="JUC常用工具类"><!---->JUC常用工具类<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="MySQL"><span class="title"><!---->MySQL</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/MySQL/MySQL%E5%B8%B8%E7%94%A8%E8%AF%AD%E5%8F%A5.html" aria-label="MySQL常用语句"><!---->MySQL常用语句<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/MySQL/MySQL%E4%B8%AD%E7%9A%84%E4%BA%8B%E5%8A%A1.html" aria-label="MySQL中的事务"><!---->MySQL中的事务<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/MySQL/%E4%B8%80%E6%9D%A1SQL%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.html" aria-label="一条SQL的执行过程"><!---->一条SQL的执行过程<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/MySQL/MySQL%E4%B8%ADdatetime%E5%92%8Ctimestamp%E7%9A%84%E5%8C%BA%E5%88%AB%E4%B8%8E%E9%80%89%E6%8B%A9.html" aria-label="MySQL中datetime和timestamp的区别与选择"><!---->MySQL中datetime和timestamp的区别与选择<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/MySQL/%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95%E5%92%8C%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8C%BA%E5%88%AB.html" aria-label="普通索引和唯一索引的区别"><!---->普通索引和唯一索引的区别<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/MySQL/Explain%E8%AF%AD%E5%8F%A5.html" aria-label="Explain语句"><!---->Explain语句<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/MySQL/MySQL%E7%9A%84%E6%89%A7%E8%A1%8C%E6%88%90%E6%9C%AC%E6%80%8E%E4%B9%88%E7%AE%97.html" aria-label="MySQL的执行成本怎么算"><!---->MySQL的执行成本怎么算<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/MySQL/MVCC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html" aria-label="MVCC实现原理"><!---->MVCC实现原理<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Redis"><span class="title"><!---->Redis</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/Redis%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C.html" aria-label="Redis的安装与基本操作"><!---->Redis的安装与基本操作<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/Redis%E7%9A%843%E7%A7%8D%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B.html" aria-label="Redis的3种特殊类型"><!---->Redis的3种特殊类型<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/Redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%8B%E7%BB%8D.html" aria-label="Redis配置文件介绍"><!---->Redis配置文件介绍<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/Redis%E7%9A%84Java%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%A4%BA%E4%BE%8B.html" aria-label="Redis的Java客户端示例"><!---->Redis的Java客户端示例<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/Redis%E4%BA%8B%E5%8A%A1.html" aria-label="Redis事务"><!---->Redis事务<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/RDB%E7%AE%80%E4%BB%8B.html" aria-label="RDB简介"><!---->RDB简介<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/AOF%E7%AE%80%E4%BB%8B.html" aria-label="AOF简介"><!---->AOF简介<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8F%8A%E5%93%A8%E5%85%B5.html" aria-label="主从复制及哨兵"><!---->主从复制及哨兵<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/Redis%E9%9B%86%E7%BE%A4.html" aria-label="Redis集群"><!---->Redis集群<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Redis/%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%E4%BC%9A%E5%AD%98%E5%9C%A8%E5%93%AA%E4%BA%9B%E9%97%AE%E9%A2%98.html" aria-label="使用缓存会存在哪些问题"><!---->使用缓存会存在哪些问题<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="工具"><span class="title"><!---->工具</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Git</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Git/Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html" aria-label="Git常用命令"><!---->Git常用命令<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Git/Git%20%E6%8F%90%E4%BA%A4%E8%A7%84%E7%BA%A6.html" aria-label="Git 提交规约"><!---->Git 提交规约<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Linux</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Linux/Linux%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.html" aria-label="Linux的文件结构"><!---->Linux的文件结构<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Linux/Linux%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86.html" aria-label="Linux的进程管理"><!---->Linux的进程管理<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Linux/Linux%E5%B8%B8%E7%94%A8%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4.html" aria-label="Linux常用网络命令"><!---->Linux常用网络命令<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Docker</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Docker/Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html" aria-label="Docker常用命令"><!---->Docker常用命令<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Docker/DokcerCompose%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html" aria-label="DokcerCompose简单使用"><!---->DokcerCompose简单使用<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Nginx</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Nginx/Nginx%E7%9A%84%E5%AE%89%E8%A3%85.html" aria-label="Nginx的安装"><!---->Nginx的安装<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/Nginx/Nginx%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8.html" aria-label="Nginx基础入门"><!---->Nginx基础入门<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>其他</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/Arthas%E4%BD%BF%E7%94%A8%E5%B0%8F%E7%BB%93.html" aria-label="Arthas使用小结"><!---->Arthas使用小结<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/工具/其他/基于Gitee实现Jenkins自动化部署SpringBoot项目/" aria-label="基于Gitee实现Jenkins自动化部署SpringBoot项目"><!---->基于Gitee实现Jenkins自动化部署SpringBoot项目<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E5%B7%A5%E5%85%B7/%E5%85%B6%E4%BB%96/%E5%9F%BA%E4%BA%8Ejmeter%E5%AE%8C%E6%88%90%E5%8E%8B%E6%B5%8B.html" aria-label="基于jmeter完成压测"><!---->基于jmeter完成压测<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="分布式"><span class="title"><!---->分布式</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/%E5%88%86%E5%B8%83%E5%BC%8F/CAP%E5%92%8CBASE%E7%90%86%E8%AE%BA.html" aria-label="CAP和BASE理论"><!---->CAP和BASE理论<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html" aria-label="分布式事务的解决方案"><!---->分布式事务的解决方案<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%87%A0%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F.html" aria-label="分布式锁的几种实现方式"><!---->分布式锁的几种实现方式<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/%E5%88%86%E5%B8%83%E5%BC%8F/%E4%BB%80%E4%B9%88%E6%98%AFxxl-job%EF%BC%8C%E5%AE%83%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98.html" aria-label="什么是xxl-job，它解决什么问题"><!---->什么是xxl-job，它解决什么问题<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="框架"><span class="title"><!---->框架</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E6%A1%86%E6%9E%B6/Spring/Spring%E7%9A%84%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3.html" aria-label="Spring的常用注解"><!---->Spring的常用注解<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E6%A1%86%E6%9E%B6/Spring/@Autowired%E6%B3%A8%E8%A7%A3%E8%AF%A6%E8%A7%A3.html" aria-label="@Autowired注解详解"><!---->@Autowired注解详解<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/框架/Spring/SpringBean的作用域.html" aria-label="SpringBean的作用域"><!---->SpringBean的作用域<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E6%A1%86%E6%9E%B6/Spring/Spring%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98%E4%B8%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.html" aria-label="Spring三级缓存与循环依赖"><!---->Spring三级缓存与循环依赖<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E6%A1%86%E6%9E%B6/Spring/JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%92%8CCGlib%E4%BB%A3%E7%90%86.html" aria-label="JDK动态代理和CGlib代理"><!---->JDK动态代理和CGlib代理<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Netty</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E6%A1%86%E6%9E%B6/Netty/Netty%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8%E5%B0%8F%E7%BB%93.html" aria-label="Netty基础概念入门小结"><!---->Netty基础概念入门小结<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="中间件"><span class="title"><!---->中间件</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>消息队列</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/RabbitMQ%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html" aria-label="RabbitMQ简单使用"><!---->RabbitMQ简单使用<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Canal</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link active" href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/Canal/Canal%E7%9A%84%E4%BD%BF%E7%94%A8.html" aria-label="Canal的使用"><!---->Canal的使用<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Sharding-JDBC</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/中间件/Canal/Canal的使用/Sharding-JDBC的简单使用.html" aria-label="Sharding-JDBC的简单使用"><!---->Sharding-JDBC的简单使用<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="业务理解"><span class="title"><!---->业务理解</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/%E4%B8%9A%E5%8A%A1%E7%90%86%E8%A7%A3/%E5%AF%B9%E6%94%AF%E4%BB%98%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%B8%AA%E4%BA%BA%E7%90%86%E8%A7%A3.html" aria-label="对支付系统的个人理解"><!---->对支付系统的个人理解<!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->一、背景</h1><div class="page-info"><span class="page-author-info" aria-label="作者"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">maijunxuan</span></span><span property="author" content="maijunxuan"></span></span><!----><!----><!----><span class="page-word-info" aria-label="字数"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 2427 字</span><meta property="wordCount" content="2427"></span><span class="page-reading-time-info" aria-label="阅读时间"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 8 分钟</span><meta property="timeRequired" content="PT8M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#_1、mysql配置相关">1、mysql配置相关</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#_1、检测binlog是否开启">1、检测binlog是否开启</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#_2、mysql开启binlog">2、mysql开启binlog</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#_3、创建canal用户">3、创建canal用户</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#_2、canal配置相关">2、canal配置相关</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#_1、下载canal">1、下载canal</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#_2、配置一个instance">2、配置一个instance</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#_3、canal-properties配置相关">3、canal.properties配置相关</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#_1、canal-destinations配置">1、canal.destinations配置</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#_2、canal-auto-scan配置">2、canal.auto.scan配置</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#_3、启动canal">3、启动canal</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#_1、引入依赖">1、引入依赖</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#_2、编写客户端代码">2、编写客户端代码</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#_3、测试结果">3、测试结果</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="一、背景" tabindex="-1"><a class="header-anchor" href="#一、背景"><span>一、背景</span></a></h1><p>工作中有个需求，当数据库的数据变更时，另外一个系统中的数据要能及时感应到，通过调研知道，监听数据库的<code>binlog</code>可以做到一个准实时的通知，而<code>canal</code>主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费，正好满足需求，此处记录一下<code>canal</code>的简单使用。</p><h1 id="二、canal的工作原理" tabindex="-1"><a class="header-anchor" href="#二、canal的工作原理"><span>二、canal的工作原理</span></a></h1><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/202208080239150.webp" alt="canal的工作原理"></p><p><strong>步骤：</strong></p><ol><li>canal模拟mysql slave的交互协议，伪装自己为mysql slave，向mysql master发送dump协议</li><li>mysql master收到dump请求，开始推送binary log给slave(也就是canal)</li><li>canal解析binary log对象(原始为byte流)</li></ol><h1 id="三、安装canal" tabindex="-1"><a class="header-anchor" href="#三、安装canal"><span>三、安装canal</span></a></h1><h2 id="_1、mysql配置相关" tabindex="-1"><a class="header-anchor" href="#_1、mysql配置相关"><span>1、mysql配置相关</span></a></h2><h3 id="_1、检测binlog是否开启" tabindex="-1"><a class="header-anchor" href="#_1、检测binlog是否开启"><span>1、检测binlog是否开启</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;log_bin&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> log_bin       <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>log_bin</code>的值为<code>ON</code>说明打开了。</p><h3 id="_2、mysql开启binlog" tabindex="-1"><a class="header-anchor" href="#_2、mysql开启binlog"><span>2、mysql开启binlog</span></a></h3><div class="language-ini line-numbers-mode" data-ext="ini" data-title="ini"><pre class="language-ini"><code><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqld</span><span class="token punctuation">]</span></span>
<span class="token comment">#binlog日志的基本文件名，需要注意的是启动mysql的用户需要对这个目录(/usr/local/var/mysql/binlog)有写入的权限</span>
<span class="token key attr-name">log_bin</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/local/var/mysql/binlog/mysql-bin</span>
<span class="token comment"># 配置binlog日志的格式</span>
<span class="token key attr-name">binlog_format</span> <span class="token punctuation">=</span> <span class="token value attr-value">ROW</span>
<span class="token comment"># 配置 MySQL replaction 需要定义，不能和 canal 的 slaveId 重复</span>
<span class="token key attr-name">server-id</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token comment"># 设置中继日志的路径</span>
<span class="token key attr-name">relay_log</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/local/var/mysql/relaylog/mysql-relay</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3、创建canal用户" tabindex="-1"><a class="header-anchor" href="#_3、创建canal用户"><span>3、创建canal用户</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> canal IDENTIFIED <span class="token keyword">BY</span> <span class="token string">&#39;canal&#39;</span><span class="token punctuation">;</span>  
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> SLAVE<span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> CLIENT <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;canal&#39;</span><span class="token variable">@&#39;%&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- GRANT ALL PRIVILEGES ON *.* TO &#39;canal&#39;@&#39;%&#39; ;</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、canal配置相关" tabindex="-1"><a class="header-anchor" href="#_2、canal配置相关"><span>2、canal配置相关</span></a></h2><h3 id="_1、下载canal" tabindex="-1"><a class="header-anchor" href="#_1、下载canal"><span>1、下载canal</span></a></h3><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code> <span class="token comment"># 1.下载 deployer</span>
 $ <span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.deployer-1.1.5.tar.gz
 <span class="token comment"># 下载适配器，不是必须的</span>
 $ <span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.adapter-1.1.5.tar.gz 
 <span class="token comment"># 下载管理台，不是必须的</span>
 $ <span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.admin-1.1.5.tar.gz
 <span class="token comment"># 下载示例程序</span>
 $ <span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.example-1.1.5.tar.gz
 
 <span class="token comment"># 2.解压 deployer (解压后的目录要存在)</span>
 <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> canal.deployer-1.1.5.tar.gz <span class="token parameter variable">-C</span> /Users/huan/soft/canal/deployer/
 
 <span class="token comment"># 3. 查看 conf 目录结构</span>
 $ tree conf                  
 conf
 ├── canal.properties
 ├── canal_local.properties
 ├── example
 │   └── instance.properties
 ├── logback.xml
 ├── metrics
 │   └── Canal_instances_tmpl.json
 └── spring
    ├── base-instance.xml
    ├── default-instance.xml
    ├── file-instance.xml
    ├── group-instance.xml
    ├── memory-instance.xml
    └── tsdb
        ├── h2-tsdb.xml
        ├── mysql-tsdb.xml
        ├── sql
        │   └── create_table.sql
        └── sql-map
            ├── sqlmap-config.xml
            ├── sqlmap_history.xml
            └── sqlmap_snapshot.xml

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2、配置一个instance" tabindex="-1"><a class="header-anchor" href="#_2、配置一个instance"><span>2、配置一个instance</span></a></h3><p><code>instance</code>：一个<code>instance</code>就是一个消息队列，每个instance通道都有各自的一份配置，因为每个mysql的ip，帐号，密码等信息各不相同。</p><p>一个<code>canal server</code>可以存在多个<code>instance</code>。</p><h4 id="_1、复制conf-example文件夹" tabindex="-1"><a class="header-anchor" href="#_1、复制conf-example文件夹"><span>1、复制<code>conf/example</code>文件夹</span></a></h4><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">cp</span> <span class="token parameter variable">-r</span> conf/example conf/customer

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>customer</code>可以简单理解为此处我需要链接<code>customer</code>数据库，因此命名为这个。</p><h4 id="_2、修改instance的配置" tabindex="-1"><a class="header-anchor" href="#_2、修改instance的配置"><span>2、修改instance的配置</span></a></h4><p><strong>vim conf/customer/instance.properties</strong></p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># mysql集群配置中的serverId概念，需要保证和当前mysql集群中id唯一 (v1.1.x版本之后canal会自动生成，不需要手工指定)</span>
<span class="token comment"># canal.instance.mysql.slaveId=0</span>
<span class="token comment"># mysql主库链接地址</span>
<span class="token key attr-name">canal.instance.master.address</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:3306</span>
<span class="token comment"># mysql主库链接时起始的binlog文件</span>
<span class="token key attr-name">canal.instance.master.journal.name</span><span class="token punctuation">=</span>
<span class="token comment"># mysql主库链接时起始的binlog偏移量</span>
<span class="token key attr-name">canal.instance.master.position</span><span class="token punctuation">=</span>
<span class="token comment"># mysql主库链接时起始的binlog的时间戳</span>
<span class="token key attr-name">canal.instance.master.timestamp</span><span class="token punctuation">=</span>

<span class="token comment"># mysql数据库帐号(此处的用户名和密码为 安装canal#mysql配置相关#创建canal用户 这一步创建的用户名和密码)</span>
<span class="token key attr-name">canal.instance.dbUsername</span><span class="token punctuation">=</span><span class="token value attr-value">canal</span>
<span class="token comment"># mysql数据库密码</span>
<span class="token key attr-name">canal.instance.dbPassword</span><span class="token punctuation">=</span><span class="token value attr-value">canal</span>
<span class="token comment"># mysql 数据解析编码</span>
<span class="token key attr-name">canal.instance.connectionCharset</span> <span class="token punctuation">=</span> <span class="token value attr-value">UTF-8</span>

<span class="token comment"># mysql 数据解析关注的表，Perl正则表达式，即我们需要关注那些库和那些表的binlog数据，也可以在canal client api中手动覆盖</span>
<span class="token key attr-name">canal.instance.filter.regex</span><span class="token punctuation">=</span><span class="token value attr-value">.*\\..*</span>
<span class="token comment"># table black regex</span>
<span class="token comment"># mysql 数据解析表的黑名单，表达式规则见白名单的规则</span>
<span class="token key attr-name">canal.instance.filter.black.regex</span><span class="token punctuation">=</span><span class="token value attr-value">mysql\\.slave_.*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、instance注意事项" tabindex="-1"><a class="header-anchor" href="#_3、instance注意事项"><span>3、instance注意事项</span></a></h4><h5 id="_1、配置需要关注那个库和那个表的binlog" tabindex="-1"><a class="header-anchor" href="#_1、配置需要关注那个库和那个表的binlog"><span>1、配置需要关注那个库和那个表的binlog</span></a></h5><p>修改 <code>instance.properties</code>文件的这个属性<code>canal.instance.filter.regex</code>,规则如下：</p><ol><li>所有表：.* or .<em>\..</em></li><li>canal schema下所有表： canal\..*</li><li>canal下的以canal打头的表：canal\.canal.*</li><li>canal schema下的一张表：canal\.test1</li><li>多个规则组合使用：canal\..*,mysql.test1,mysql.test2 (逗号分隔)</li></ol><h5 id="_2、mysql链接时的起始位置" tabindex="-1"><a class="header-anchor" href="#_2、mysql链接时的起始位置"><span>2、mysql链接时的起始位置</span></a></h5><ul><li>canal.instance.master.journal.name + canal.instance.master.position : 精确指定一个binlog位点，进行启动</li><li>canal.instance.master.timestamp : 指定一个时间戳，canal会自动遍历mysql binlog，找到对应时间戳的binlog位点后，进行启动</li><li>不指定任何信息：默认从当前数据库的位点，进行启动。(show master status)</li></ul><h5 id="_3、mysql解析关注表定义" tabindex="-1"><a class="header-anchor" href="#_3、mysql解析关注表定义"><span>3、mysql解析关注表定义</span></a></h5><ul><li>标准的Perl正则，注意转义时需要双斜杠：\</li></ul><h5 id="_4、mysql链接的编码" tabindex="-1"><a class="header-anchor" href="#_4、mysql链接的编码"><span>4、mysql链接的编码</span></a></h5><ul><li><code>目前canal版本仅支持一个数据库只有一种编码</code>，如果一个库存在多个编码，需要通过filter.regex配置，将其拆分为多个canal instance，<code>为每个instance指定不同的编码</code></li></ul><h2 id="_3、canal-properties配置相关" tabindex="-1"><a class="header-anchor" href="#_3、canal-properties配置相关"><span>3、canal.properties配置相关</span></a></h2><p><strong>vim conf/canal.properties</strong></p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># canal server绑定的本地IP信息，如果不配置，默认选择一个本机IP进行启动服务</span>
<span class="token key attr-name">canal.ip</span> <span class="token punctuation">=</span> <span class="token value attr-value">127.0.0.1</span>
<span class="token comment"># canal server提供socket服务的端口</span>
<span class="token key attr-name">canal.port</span> <span class="token punctuation">=</span> <span class="token value attr-value">1111</span>
<span class="token comment"># metrics 端口</span>
<span class="token key attr-name">canal.metrics.pull.port</span> <span class="token punctuation">=</span> <span class="token value attr-value">11112</span>
<span class="token comment"># canal 服务的用户名（客户端连接的时候需要这个用户名和密码，也可以不配置）</span>
<span class="token key attr-name">canal.user</span> <span class="token punctuation">=</span> <span class="token value attr-value">canal</span>
<span class="token comment"># canal 服务的密码</span>
<span class="token key attr-name">canal.passwd</span> <span class="token punctuation">=</span> <span class="token value attr-value">123456</span>
<span class="token comment"># tcp, kafka, rocketMQ, rabbitMQ（如果我们要将数据发送到kafka中，则此处写kafka，然后配置kafka的配置，此处以tcp演示）</span>
<span class="token key attr-name">canal.serverMode</span> <span class="token punctuation">=</span> <span class="token value attr-value">tcp</span>
<span class="token comment"># 当前server上部署的instance列表,此处写 customer ,则和 conf 目录同级下必须要有一个 customer 文件夹，即上一步我们创建的，如果有多个instance说，则以英文的逗号隔开</span>
<span class="token key attr-name">canal.destinations</span> <span class="token punctuation">=</span> <span class="token value attr-value">customer</span>
<span class="token comment"># 如果系统是1个cpu，那么需要将这个并行设置成false</span>
<span class="token key attr-name">canal.instance.parser.parallel</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意事项：</strong></p><h3 id="_1、canal-destinations配置" tabindex="-1"><a class="header-anchor" href="#_1、canal-destinations配置"><span>1、canal.destinations配置</span></a></h3><p>在canal.properties定义了canal.destinations后，需要在canal.conf.dir对应的目录下建立同名的文件</p><p><strong>比如：</strong></p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">canal.destinations</span> <span class="token punctuation">=</span> <span class="token value attr-value">example1,example2</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这时需要创建example1和example2两个目录，每个目录里各自有一份instance.properties.</p><p>ps. canal自带了一份instance.properties demo，可直接复制conf/example目录进行配置修改</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">cp</span> <span class="token parameter variable">-R</span> example example1/
<span class="token function">cp</span> <span class="token parameter variable">-R</span> example example2/

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2、canal-auto-scan配置" tabindex="-1"><a class="header-anchor" href="#_2、canal-auto-scan配置"><span>2、canal.auto.scan配置</span></a></h3><p>如果canal.properties未定义instance列表，但开启了canal.auto.scan时</p><ul><li>server第一次启动时，会自动扫描conf目录下，将文件名做为instance name，启动对应的instance</li><li>server运行过程中，会根据canal.auto.scan.interval定义的频率，进行扫描 <ol><li>发现目录有新增，启动新的instance</li><li>发现目录有删除，关闭老的instance</li><li>发现对应目录的instance.properties有变化，重启instance</li></ol></li></ul><h3 id="_3、启动canal" tabindex="-1"><a class="header-anchor" href="#_3、启动canal"><span>3、启动canal</span></a></h3><p>1、启动canal</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 启动canal server</span>
<span class="token function">sh</span> bin/startup.sh

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、查看日志</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># canal查看日志</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-n200</span> logs/canal/canal.log
<span class="token comment"># 如果canal启动失败则需要查看此日志</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-n200</span> logs/canal/canal_stdout.log

<span class="token comment"># 查看instance日志,由上面的配置可知，我们的instance的名字是customer,所以看这个日志. </span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-n200</span> logs/customer/customer.log

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、jdk版本</p><p>启动的时候需要注意一下本地<code>JDK</code>的版本，测试时发现使用jdk11不能启动，使用jdk8可以启动。</p><h1 id="四、客户端消费canal数据" tabindex="-1"><a class="header-anchor" href="#四、客户端消费canal数据"><span>四、客户端消费canal数据</span></a></h1><h2 id="_1、引入依赖" tabindex="-1"><a class="header-anchor" href="#_1、引入依赖"><span>1、引入依赖</span></a></h2><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.otter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>canal.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.otter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>canal.protocol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.otter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>canal.common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、编写客户端代码" tabindex="-1"><a class="header-anchor" href="#_2、编写客户端代码"><span>2、编写客户端代码</span></a></h2><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">CanalConnector</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">CanalConnectors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token class-name">CanalEntry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetSocketAddress</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * canal client api 的使用
 * https://github.com/alibaba/canal/wiki/ClientExample
 * 测试过程中发现，如果修改一个sql语句，但是修改的值没有发生变化，则此处不会监控到。
 * 同一个客户端启动多次，只有一个客户端可以获取到数据
 *
 * <span class="token keyword">@author</span> huan.fu 2021/5/31 - 上午10:31
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CanalClientApi</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> destination <span class="token operator">=</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建一个 canal 链接</span>
        <span class="token class-name">CanalConnector</span> canalConnector <span class="token operator">=</span> <span class="token class-name">CanalConnectors</span><span class="token punctuation">.</span><span class="token function">newSingleConnector</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">11111</span><span class="token punctuation">)</span><span class="token punctuation">,</span> destination<span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 链接对应的canal server</span>
        canalConnector<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅那个库的那个表等</span>
        <span class="token doc-comment comment">/**
         * 订阅规则
         * 1.  所有表：.*   or  .*\\..*
         * 2.  canal schema下所有表： canal\\..*
         * 3.  canal下的以canal打头的表：canal\\.canal.*
         * 4.  canal schema下的一张表：canal\\.test1
         * 5.  多个规则组合使用：canal\\..*,mysql.test1,mysql.test2 (逗号分隔)
         */</span>
        canalConnector<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;temp_work\\.customer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 回滚到未进行 #ack 的地方，下次fetch的时候，可以从最后一个没有 #ack 的地方开始拿</span>
        canalConnector<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> batchSize <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取一批数据，不一定会获取到 batchSize 条</span>
            <span class="token class-name">Message</span> message <span class="token operator">=</span> canalConnector<span class="token punctuation">.</span><span class="token function">getWithoutAck</span><span class="token punctuation">(</span>batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取批次id</span>
            <span class="token keyword">long</span> batchId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取数据</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>batchId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> entries<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;没有获取到数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>Entry</span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">CanalEntry<span class="token punctuation">.</span>EntryType</span><span class="token punctuation">.</span><span class="token constant">TRANSACTIONBEGIN</span> <span class="token operator">||</span> entry<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">CanalEntry<span class="token punctuation">.</span>EntryType</span><span class="token punctuation">.</span><span class="token constant">TRANSACTIONEND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">CanalEntry<span class="token punctuation">.</span>RowChange</span> rowChange<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    rowChange <span class="token operator">=</span> <span class="token class-name">CanalEntry<span class="token punctuation">.</span>RowChange</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getStoreValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;解析binlog数据出现异常 , data:&quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">CanalEntry<span class="token punctuation">.</span>EventType</span> eventType <span class="token operator">=</span> rowChange<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;================&gt; binlog[%s:%s] , name[%s,%s] , eventType : %s&quot;</span><span class="token punctuation">,</span>
                        entry<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLogfileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLogfileOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        entry<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSchemaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        eventType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>eventType <span class="token operator">==</span> <span class="token class-name">CanalEntry<span class="token punctuation">.</span>EventType</span><span class="token punctuation">.</span><span class="token constant">QUERY</span> <span class="token operator">||</span> rowChange<span class="token punctuation">.</span><span class="token function">getIsDdl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;sql =&gt; &quot;</span> <span class="token operator">+</span> rowChange<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>RowData</span> rowData <span class="token operator">:</span> rowChange<span class="token punctuation">.</span><span class="token function">getRowDatasList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventType <span class="token operator">==</span> <span class="token class-name">CanalEntry<span class="token punctuation">.</span>EventType</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">printColumn</span><span class="token punctuation">(</span>rowData<span class="token punctuation">.</span><span class="token function">getBeforeColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>eventType <span class="token operator">==</span> <span class="token class-name">CanalEntry<span class="token punctuation">.</span>EventType</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">printColumn</span><span class="token punctuation">(</span>rowData<span class="token punctuation">.</span><span class="token function">getAfterColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-------&gt; before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">printColumn</span><span class="token punctuation">(</span>rowData<span class="token punctuation">.</span><span class="token function">getBeforeColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-------&gt; after&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">printColumn</span><span class="token punctuation">(</span>rowData<span class="token punctuation">.</span><span class="token function">getAfterColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            canalConnector<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span>batchId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printColumn</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>Column</span><span class="token punctuation">&gt;</span></span> columns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>Column</span> column <span class="token operator">:</span> columns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>column<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> column<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;    update=&quot;</span> <span class="token operator">+</span> column<span class="token punctuation">.</span><span class="token function">getUpdated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意⚠️：</strong></p><p>经测试，同一个客户端代码，启动多份，模拟多个客户端同时消费，只有一个客户端可以消费数据。</p><h2 id="_3、测试结果" tabindex="-1"><a class="header-anchor" href="#_3、测试结果"><span>3、测试结果</span></a></h2><div class="language-ini line-numbers-mode" data-ext="ini" data-title="ini"><pre class="language-ini"><code>没有获取到数据
没有获取到数据
<span class="token punctuation">=</span><span class="token value attr-value">===============&gt; binlog[mysql-bin.000014:5771] , name[temp_work,customer] , eventType : UPDATE</span>
-------&gt; before
<span class="token key attr-name">id : 12    update</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token key attr-name">phone : 123    update</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token key attr-name">address : abcdefg    update</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token key attr-name">column_4 :     update</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
-------&gt; after
<span class="token key attr-name">id : 12    update</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token key attr-name">phone : 123    update</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token key attr-name">address : 数据改变    update</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">column_4 :     update</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
没有获取到数据
没有获取到数据

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到获取到了，改变后的数据。</p><h1 id="五、消费的binlog不存在" tabindex="-1"><a class="header-anchor" href="#五、消费的binlog不存在"><span>五、消费的binlog不存在</span></a></h1><p>1、查看数据库中binlog文件的位置</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;log_bin_basename&#39;</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>2、找到binlog文件和位置</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment"># 查询 mysql-bin.000026 这个binlog文件，从pos点: 4 开始查起，一共查询查询5条</span>
<span class="token keyword">show</span> binlog events <span class="token operator">in</span> <span class="token string">&#39;mysql-bin.000026&#39;</span> <span class="token keyword">from</span> <span class="token number">4</span> <span class="token keyword">limit</span> <span class="token number">5</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、停止canal-server</p><p>4、修改<code>instance</code>下的 <code>instance.properties</code>下的如下配置</p><p><img src="https://cdn.jsdelivr.net/gh/mai-junxuan/Cloud-image/image/202209022334753.webp" alt="canal instance配置文件修改"></p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># mysql主库链接时起始的binlog文件</span>
<span class="token key attr-name">canal.instance.master.journal.name</span><span class="token punctuation">=</span><span class="token value attr-value">mysql-bin.000026</span>
<span class="token comment"># mysql主库链接时起始的binlog偏移量</span>
<span class="token key attr-name">canal.instance.master.position</span><span class="token punctuation">=</span><span class="token value attr-value">4</span>
<span class="token comment"># mysql主库链接时起始的binlog的时间戳</span>
<span class="token key attr-name">canal.instance.master.timestamp</span><span class="token punctuation">=</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5、删除<code>meta.data</code>文件。</p><p><strong>注意⚠️：</strong></p><p>可能会出现的一个问题: <code>column size is not match for table:temp_work.customer,4 vs 3</code>，这个是因为binlog中的表结构和我们真实库中的表结构对不起来。</p></div><!--[--><!----><!--]--><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1585225345@qq.com">MJX</span><!--]--><!--]--></div></div></footer><!----><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">Copyright © 2024 maijunxuan </div></footer></div><!--]--><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Digg1ELS.js" defer></script>
  </body>
</html>
